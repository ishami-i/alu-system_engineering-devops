#!/usr/bin/env bash
# Configures a new Ubuntu machine with Nginx to serve a custom 404 page containing "Ceci n'est pas une page"

set -e

# Update and install Nginx
apt-get update -y -qq
apt-get install nginx -y

# Start Nginx without systemctl
service nginx start || /etc/init.d/nginx start

# Allow HTTP through UFW if available
if command -v ufw >/dev/null 2>&1; then
    ufw allow 'Nginx HTTP' >/dev/null 2>&1 || true
fi

# Overwrite default index page
echo "Holberton School" > /var/www/html/index.html

# Create custom 404 page
echo "Ceci n'est pas une page" > /var/www/html/error_404.html

# Configure Nginx to use the custom 404 page
cat <<EOF > /etc/nginx/sites-available/default
server {
    listen 80 default_server;
    listen [::]:80 default_server;

    root /var/www/html;
    index index.html;

    server_name _;

    location / {
        try_files \$uri \$uri/ =404;
    }

    error_page 404 /error_404.html;
}
EOF

# Restart Nginx
service nginx restart || /etc/init.d/nginx restart

# Verification
if curl -sI localhost/doesnotexist | grep -q "404 Not Found" && \
   curl -s localhost/doesnotexist | grep -q "Ceci n'est pas une page"; then
    echo "Custom 404 page configured successfully."
else
    echo "Failed to configure 404 page." >&2
    exit 1
fi
